<style is:global>
  #shaders {
    position: absolute;
    z-index: -1;
    width: stretch;
    height: stretch;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    mix-blend-mode: plus-lighter;
    overflow: hidden;
    pointer-events: none;
  }
</style>

<div id="shaders" transition:persist></div>

<script>
  import { Shader } from "./shaders/combined";
  
  const routes = ["/about", "/guide"];
  const shader = new Shader();
  
  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  
  if (prefersReducedMotion) {
    shader.pause();
  }
  
  function handleRouteChange() {
    const currentPath = window.location.pathname;
    const shouldPause = routes.includes(currentPath) || prefersReducedMotion;
    
    if (shouldPause) {
      shader.pause();
    } else {
      // Only resume if user doesn't prefer reduced motion
      if (!prefersReducedMotion) {
        shader.resume();
      }
    }
  }
  
  // Listen for Astro navigation events
  document.addEventListener('astro:page-load', handleRouteChange);
  document.addEventListener('astro:after-swap', handleRouteChange);
  
  // Handle initial page load
  handleRouteChange();
  
  window.matchMedia('(prefers-reduced-motion: reduce)').addEventListener('change', (e) => {
    if (e.matches) {
      shader.pause();
    } else {
      // Only resume if we're not on a route that should be paused
      const currentPath = window.location.pathname;
      if (!routes.includes(currentPath)) {
        shader.resume();
      }
    }
  });
</script>